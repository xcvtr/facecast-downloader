# Facecast Video Downloader

Инструмент для скачивания видео с платформы facecast.net с поддержкой параллельного скачивания сегментов.

## Возможности

- ✅ Скачивание видео по URL с facecast.net
- ✅ Автоматическое определение формата потока (HLS/M3U8)
- ✅ Выбор наилучшего качества из доступных
- ✅ Параллельное скачивание сегментов (по умолчанию 5 потоков)
- ✅ Отображение прогресса скачивания
- ✅ Автоматическое объединение сегментов в единый файл
- ✅ Повторные попытки при ошибках сети (до 3 раз)
- ✅ Обработка конфликтов имен файлов

## Установка

### Требования

- Python 3.8 или выше
- pip (менеджер пакетов Python)

### Установка зависимостей

```bash
pip install -r requirements.txt
```

### Установка пакета

```bash
pip install -e .
```

После установки команда `facecast-dl` будет доступна глобально.

## Использование

### Базовое использование

Скачать видео в текущую директорию:

```bash
python -m src.cli https://facecast.net/w/311ty3
```

Или если установлен пакет:

```bash
facecast-dl https://facecast.net/w/311ty3
```

### Параметры командной строки

- `-o, --output-dir` - директория для сохранения (по умолчанию: текущая)
- `-f, --filename` - имя файла (по умолчанию: video_id.mp4)
- `-w, --workers` - количество параллельных потоков (по умолчанию: 5)
- `-h, --help` - показать справку

### Примеры

**Базовая команда:**
```bash
python -m src.cli https://facecast.net/w/311ty3
```

**Указать директорию для сохранения:**
```bash
python -m src.cli https://facecast.net/w/311ty3 -o ./videos
```

**Указать имя файла:**
```bash
python -m src.cli https://facecast.net/w/311ty3 -f my_video.mp4
```

**Указать количество потоков:**
```bash
python -m src.cli https://facecast.net/w/311ty3 -w 10
```

**Все параметры вместе:**
```bash
python -m src.cli https://facecast.net/w/311ty3 -o ./videos -f video.mp4 -w 10
```

### Рекомендации по количеству потоков

- **Для быстрого скачивания**: используйте 10-15 потоков
- **Для медленного интернета**: используйте 3-5 потоков
- **Не используйте более 20 потоков** - может привести к блокировке

### Пример вывода

```
============================================================
Facecast Video Downloader
============================================================

[1/5] Парсинг URL...
✓ Video ID: 311ty3

[2/5] Получение метаданных видео...
✓ Найден видеопоток: m3u8

[3/5] Подготовка выходного файла...
✓ Файл будет сохранен: ./downloads\311ty3.mp4

[4/5] Парсинг M3U8 плейлиста...
✓ Найдено сегментов: 3214

[5/5] Скачивание видео...
Параллельных потоков: 10
Скачивание сегментов: [████████████████████] 3214/3214 (100.0%)

✓ Видео успешно сохранено!
============================================================
```

## Как это работает

1. **Парсинг URL** - извлекается video_id из URL
2. **Получение метаданных** - загружается HTML-страница и извлекаются данные о видео (event_id, серверы)
3. **Построение URL потока** - формируется URL для M3U8 плейлиста
4. **Парсинг M3U8** - извлекаются URL всех видео сегментов
5. **Параллельное скачивание** - сегменты скачиваются одновременно в несколько потоков
6. **Объединение** - все сегменты объединяются в единый MP4 файл

## Структура проекта

```
facecast-downloader/
├── src/
│   ├── __init__.py
│   ├── cli.py              # CLI интерфейс
│   ├── url_parser.py       # Парсинг URL
│   ├── metadata.py         # Извлечение метаданных видео
│   ├── m3u8_parser.py      # Парсинг M3U8 плейлистов
│   ├── downloader.py       # Скачивание сегментов
│   ├── progress.py         # Отображение прогресса
│   └── file_manager.py     # Управление файлами
├── tests/                  # Тесты
├── requirements.txt        # Зависимости
├── setup.py               # Установка пакета
└── README.md              # Документация
```

## Зависимости

- **requests** - HTTP-запросы
- **beautifulsoup4** - Парсинг HTML
- **pytest** - Тестирование (dev)
- **hypothesis** - Property-based тестирование (dev)

## Производительность

Параллельное скачивание значительно ускоряет процесс:

- **1 поток**: ~100% времени (базовая линия)
- **5 потоков** (по умолчанию): ~20-30% времени
- **10 потоков**: ~15-20% времени
- **20+ потоков**: может привести к ограничениям со стороны сервера

Рекомендуется использовать 5-10 потоков для оптимального баланса между скоростью и нагрузкой на сервер.

## Обработка ошибок

Программа автоматически обрабатывает:

- ✅ Сетевые ошибки (повторные попытки)
- ✅ Невалидные URL
- ✅ Недоступные видео
- ✅ Ошибки файловой системы
- ✅ Конфликты имен файлов

## Ограничения

- Поддерживаются только видео с facecast.net
- Требуется публичный доступ к видео (без авторизации)
- Скачиваются только завершенные трансляции (не live)

## Разработка

### Запуск тестов

```bash
pytest tests/
```

### Property-based тесты

```bash
pytest tests/test_properties.py
```

## Лицензия

MIT License

## Автор

Создано с помощью Kiro AI
