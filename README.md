# Facecast Video Downloader

Инструмент для скачивания видео с платформы facecast.net с поддержкой параллельного скачивания сегментов.

## Возможности

- ✅ Скачивание видео по URL с facecast.net
- ✅ Автоматическое определение формата потока (HLS/M3U8)
- ✅ Выбор наилучшего качества из доступных
- ✅ Параллельное скачивание сегментов (по умолчанию 5 потоков)
- ✅ Отображение прогресса скачивания
- ✅ Автоматическое объединение сегментов в единый файл
- ✅ Повторные попытки при ошибках сети (до 3 раз)
- ✅ Обработка конфликтов имен файлов

## Установка

### Требования

- Python 3.8 или выше
- pip (менеджер пакетов Python)

### Установка зависимостей

```bash
pip install -r requirements.txt
```

### Установка пакета

```bash
pip install -e .
```

После установки команда `facecast-dl` будет доступна глобально.

## Использование

### Базовое использование

Скачать видео в текущую директорию:

```bash
python -m src.cli https://facecast.net/w/311ty3
```

Или если установлен пакет:

```bash
facecast-dl https://facecast.net/w/311ty3
```

### Параметры командной строки

```
usage: cli.py [-h] [-o OUTPUT_DIR] [-f FILENAME] [-w WORKERS] url

Скачивание видео с facecast.net

positional arguments:
  url                   URL видео на facecast.net (например: https://facecast.net/w/311ty3)

optional arguments:
  -h, --help            показать справку
  -o OUTPUT_DIR, --output-dir OUTPUT_DIR
                        Директория для сохранения видео (по умолчанию: текущая директория)
  -f FILENAME, --filename FILENAME
                        Имя выходного файла (по умолчанию: используется video_id)
  -w WORKERS, --workers WORKERS
                        Количество параллельных потоков для скачивания (по умолчанию: 5)
```

### Примеры

**Скачать видео в текущую директорию:**
```bash
python -m src.cli https://facecast.net/w/311ty3
```

**Скачать в определенную директорию:**
```bash
python -m src.cli https://facecast.net/w/311ty3 -o ./videos
```

**Указать имя файла:**
```bash
python -m src.cli https://facecast.net/w/311ty3 -o ./videos -f my_video.mp4
```

**Использовать 10 параллельных потоков для ускорения:**
```bash
python -m src.cli https://facecast.net/w/311ty3 -w 10
```

**Использовать 1 поток (последовательное скачивание):**
```bash
python -m src.cli https://facecast.net/w/311ty3 -w 1
```

## Как это работает

1. **Парсинг URL** - извлекается video_id из URL
2. **Получение метаданных** - загружается HTML-страница и извлекаются данные о видео (event_id, серверы)
3. **Построение URL потока** - формируется URL для M3U8 плейлиста
4. **Парсинг M3U8** - извлекаются URL всех видео сегментов
5. **Параллельное скачивание** - сегменты скачиваются одновременно в несколько потоков
6. **Объединение** - все сегменты объединяются в единый MP4 файл

## Структура проекта

```
facecast-downloader/
├── src/
│   ├── __init__.py
│   ├── cli.py              # CLI интерфейс
│   ├── url_parser.py       # Парсинг URL
│   ├── metadata.py         # Извлечение метаданных видео
│   ├── m3u8_parser.py      # Парсинг M3U8 плейлистов
│   ├── downloader.py       # Скачивание сегментов
│   ├── progress.py         # Отображение прогресса
│   └── file_manager.py     # Управление файлами
├── tests/                  # Тесты
├── requirements.txt        # Зависимости
├── setup.py               # Установка пакета
└── README.md              # Документация
```

## Зависимости

- **requests** - HTTP-запросы
- **beautifulsoup4** - Парсинг HTML
- **pytest** - Тестирование (dev)
- **hypothesis** - Property-based тестирование (dev)

## Производительность

Параллельное скачивание значительно ускоряет процесс:

- **1 поток**: ~100% времени (базовая линия)
- **5 потоков** (по умолчанию): ~20-30% времени
- **10 потоков**: ~15-20% времени
- **20+ потоков**: может привести к ограничениям со стороны сервера

Рекомендуется использовать 5-10 потоков для оптимального баланса между скоростью и нагрузкой на сервер.

## Обработка ошибок

Программа автоматически обрабатывает:

- ✅ Сетевые ошибки (повторные попытки)
- ✅ Невалидные URL
- ✅ Недоступные видео
- ✅ Ошибки файловой системы
- ✅ Конфликты имен файлов

## Ограничения

- Поддерживаются только видео с facecast.net
- Требуется публичный доступ к видео (без авторизации)
- Скачиваются только завершенные трансляции (не live)

## Разработка

### Запуск тестов

```bash
pytest tests/
```

### Property-based тесты

```bash
pytest tests/test_properties.py
```

## Лицензия

MIT License

## Автор

Создано с помощью Kiro AI
